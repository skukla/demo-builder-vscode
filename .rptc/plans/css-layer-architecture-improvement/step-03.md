# Step 3: Wrap utilities/*.css in @layer utilities

## Purpose

Wrap all 6 utility CSS files in `@layer utilities` block to establish highest cascade priority. This enables utilities to override Spectrum defaults without requiring `!important` declarations.

**Important:** This is the FIRST step to ADD new @layer wrappers (Step 2 only RENAMED existing declarations). These utilities files currently have NO @layer declaration.

## Prerequisites

- [x] Step 1: @layer declaration updated to 5-layer hierarchy in index.css (REQUIRED)
- [x] Step 2: Existing @layer declarations renamed (REQUIRED)

## Tests to Write First

- [ ] Test: `utilities/animations.css` is wrapped in @layer utilities
  - **Given:** animations.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`
  - **File:** `tests/core/ui/styles/layerStructure.test.ts`

- [ ] Test: `utilities/borders.css` is wrapped in @layer utilities
  - **Given:** borders.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`

- [ ] Test: `utilities/colors.css` is wrapped in @layer utilities
  - **Given:** colors.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`

- [ ] Test: `utilities/layout.css` is wrapped in @layer utilities
  - **Given:** layout.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`

- [ ] Test: `utilities/spacing.css` is wrapped in @layer utilities
  - **Given:** spacing.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`

- [ ] Test: `utilities/typography.css` is wrapped in @layer utilities
  - **Given:** typography.css file content
  - **When:** File is parsed
  - **Then:** Content is enclosed in `@layer utilities { ... }`

- [ ] Test: Existing utility class tests still pass
  - **Given:** All utility files wrapped in @layer
  - **When:** Existing utilityClasses.test.ts runs
  - **Then:** All 40+ CSS property tests pass unchanged

## Files to Modify

| File | Change |
|------|--------|
| `src/core/ui/styles/utilities/animations.css` | Wrap content in `@layer utilities { }` |
| `src/core/ui/styles/utilities/borders.css` | Wrap content in `@layer utilities { }` |
| `src/core/ui/styles/utilities/colors.css` | Wrap content in `@layer utilities { }` |
| `src/core/ui/styles/utilities/layout.css` | Wrap content in `@layer utilities { }` |
| `src/core/ui/styles/utilities/spacing.css` | Wrap content in `@layer utilities { }` |
| `src/core/ui/styles/utilities/typography.css` | Wrap content in `@layer utilities { }` |

## Implementation Details

### RED Phase

Create `tests/core/ui/styles/layerStructure.test.ts`:

```typescript
describe('CSS Layer Structure', () => {
  describe('utilities/ files', () => {
    const utilityFiles = [
      'animations.css',
      'borders.css',
      'colors.css',
      'layout.css',
      'spacing.css',
      'typography.css',
    ];

    utilityFiles.forEach((file) => {
      it(`${file} is wrapped in @layer utilities`, () => {
        const content = readFileSync(
          join(stylesDir, 'utilities', file),
          'utf-8'
        );
        expect(content).toMatch(/^@layer utilities \{[\s\S]*\}$/);
      });
    });
  });
});
```

### GREEN Phase

For each utility file, wrap existing content:

**Pattern:**
```css
@layer utilities {
  /* existing file content (unchanged) */
}
```

**Important:** Keep all existing styles including `!important` declarations. The `!important` removal happens in Step 6 after all layers are in place.

### REFACTOR Phase

- Verify consistent indentation (2 spaces)
- Ensure closing `}` on its own line
- Preserve all file header comments above `@layer` block

## Expected Outcome

- All 6 utility files wrapped in `@layer utilities { }`
- Utility classes gain highest cascade priority (layer 5 of 5)
- Existing `utilityClasses.test.ts` tests continue passing
- New layer structure tests pass
- Visual appearance unchanged (no regressions)

## Acceptance Criteria

- [ ] `animations.css` wrapped in @layer utilities
- [ ] `borders.css` wrapped in @layer utilities
- [ ] `colors.css` wrapped in @layer utilities
- [ ] `layout.css` wrapped in @layer utilities
- [ ] `spacing.css` wrapped in @layer utilities
- [ ] `typography.css` wrapped in @layer utilities
- [ ] Layer structure tests pass
- [ ] Existing utility class tests pass
- [ ] Wizard webview renders correctly

## Dependencies from Other Steps

- **Requires:** Step 1 (5-layer declaration must be in index.css)
- **Requires:** Step 2 (theme layer should be complete for consistency)
- **Enables:** Step 6 (!important removal from utilities)

## Estimated Time

30-45 minutes

---

_Generated by Step Generator Sub-Agent_
